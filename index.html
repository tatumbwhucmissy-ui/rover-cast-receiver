<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Rover IPTV Receiver</title>

    <!-- CAF Receiver SDK -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <style>
      html, body { margin: 0; height: 100%; background: #000; }
      cast-media-player { width: 100%; height: 100%; }
      #hint {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        z-index: 2;
        color: rgba(255,255,255,0.85);
        font-family: Arial, sans-serif;
        font-size: 20px;
        letter-spacing: 0.2px;
      }
      #log {
        position: absolute;
        left: 12px;
        right: 12px;
        bottom: 12px;
        max-height: 55%;
        overflow: auto;
        color: rgba(255,255,255,0.85);
        white-space: pre-wrap;
        font-family: monospace;
        font-size: 14px;
        margin: 0;
        z-index: 3;
      }
    </style>
  </head>

  <body>
    <div id="hint">Receiver READY</div>
    <pre id="log"></pre>
    <cast-media-player></cast-media-player>

    <script>
      const hintEl = document.getElementById("hint");
      const logEl = document.getElementById("log");

      function safeJson(value) {
        try {
          return JSON.stringify(value);
        } catch (_) {
          return String(value);
        }
      }

      function log(message) {
        const line = `[${new Date().toISOString()}] ${message}`;
        console.log(line);
        if (logEl) logEl.textContent += line + "\n";
      }

      function setHint(message) {
        if (hintEl) hintEl.textContent = message;
      }

      window.onerror = (m, s, l, c) => log(`JS ERROR: ${m} @${s}:${l}:${c}`);
      window.onunhandledrejection = (e) =>
        log(`PROMISE REJECT: ${e && e.reason ? e.reason : e}`);

      function parseContentId(contentId) {
        // Supported format:
        // https://example.com/stream.m3u8|Authorization=Bearer%20TOKEN&X-Token=abc
        const raw = String(contentId || "");
        const parts = raw.split("|");
        const url = (parts[0] || "").trim();
        const headers = {};

        if (parts.length > 1 && parts[1]) {
          const kv = parts[1].split("&");
          for (const pair of kv) {
            const eq = pair.indexOf("=");
            if (eq > 0) {
              const k = decodeURIComponent(pair.slice(0, eq).trim());
              const v = decodeURIComponent(pair.slice(eq + 1).trim());
              if (k && v) headers[k] = v;
            }
          }
        }
        return { url, headers };
      }

      function startReceiver() {
        if (!window.cast || !cast.framework) {
          log("CAF SDK not available. Check access to gstatic.");
          return;
        }

        const context = cast.framework.CastReceiverContext.getInstance();
        const playerManager = context.getPlayerManager();
        const playbackConfig = new cast.framework.PlaybackConfig();

        let currentHeaders = {};
        let currentUrl = "";

        playbackConfig.manifestRequestHandler = (requestInfo) => {
          requestInfo.withCredentials = false;
          if (Object.keys(currentHeaders).length) {
            requestInfo.headers = Object.assign({}, requestInfo.headers, currentHeaders);
          }
        };

        playbackConfig.segmentRequestHandler = (requestInfo) => {
          requestInfo.withCredentials = false;
          if (Object.keys(currentHeaders).length) {
            requestInfo.headers = Object.assign({}, requestInfo.headers, currentHeaders);
          }
        };

        playerManager.setPlaybackConfig(playbackConfig);

        playerManager.setMessageInterceptor(
          cast.framework.messages.MessageType.LOAD,
          (loadRequestData) => {
            const parsed = parseContentId(loadRequestData.media && loadRequestData.media.contentId);
            const customData = loadRequestData && loadRequestData.customData;
            const customHeaders = customData && customData.headers ? customData.headers : null;
            currentHeaders = customHeaders && Object.keys(customHeaders).length
              ? customHeaders
              : parsed.headers;
            currentUrl = parsed.url;

            if (customData && customData.contentType && loadRequestData.media) {
              loadRequestData.media.contentType = customData.contentType;
            }

            if (loadRequestData.media) {
              loadRequestData.media.contentId = currentUrl;
            }

            log(`LOAD received. URL: ${currentUrl} headers: ${safeJson(currentHeaders)}`);
            log(`MEDIA INFO: ${safeJson(loadRequestData.media)}`);
            return loadRequestData;
          }
        );

        function addPmListener(type, label) {
          if (!type) {
            log(`Skip listener ${label}: event type undefined`);
            return;
          }
          playerManager.addEventListener(type, (e) => log(`${label}: ${safeJson(e)}`));
        }

        addPmListener(cast.framework.events.EventType.ERROR, "PLAYER ERROR");
        addPmListener(cast.framework.events.EventType.BUFFERING, "BUFFERING");
        addPmListener(cast.framework.events.EventType.MEDIA_STATUS, "MEDIA STATUS");
        addPmListener(cast.framework.events.EventType.PLAYER_LOAD_COMPLETE, "LOAD COMPLETE");
        addPmListener(cast.framework.events.EventType.PLAYING, "PLAYING");
        addPmListener(cast.framework.events.EventType.PAUSE, "PAUSE");

        context.addEventListener(
          cast.framework.system.EventType.ERROR,
          (event) => log(`CAST ERROR: ${safeJson(event && event.error ? event.error : event)}`)
        );

        context.addEventListener(
          cast.framework.system.EventType.READY,
          () => setHint("Receiver READY")
        );

        context.start();
        log("context.start() called");
      }

      log("Initializing receiver...");
      startReceiver();
    </script>
  </body>
</html>
