<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, viewport-fit=cover"
    />
    <title>Rover IPTV Receiver</title>

    <!-- CAF Receiver SDK -->
    <script src="https://www.gstatic.com/cast/sdk/libs/caf_receiver/v3/cast_receiver_framework.js"></script>

    <style>
      html, body { margin: 0; height: 100%; background: #000; }
      cast-media-player {
        width: 100%;
        height: 100%;
      }
      #hint,
      #errors {
        position: absolute;
        inset: 0;
        display: grid;
        place-items: center;
        z-index: 2;
        color: rgba(255,255,255,0.75);
        font-family: Arial, sans-serif;
        letter-spacing: 0.3px;
        padding: 24px;
        text-align: center;
      }

      #errors {
        z-index: 3;
        color: #ff9f9f;
        font-size: 14px;
        white-space: pre-wrap;
        display: none;
      }
    </style>
  </head>

  <body>
    <div id="hint">Ready to Cast</div>
    <div id="errors"></div>
    <cast-media-player></cast-media-player>

    <script>
      const errors = document.getElementById("errors");
      const errorMessages = [];

      function showError(message) {
        if (!errors) return;
        errorMessages.push(message);
        errors.textContent = errorMessages.join("\n");
        errors.style.display = "grid";
      }

      window.addEventListener("error", (event) => {
        const detail = event && event.message ? event.message : "Unknown error";
        showError("JS error: " + detail);
      });

      window.addEventListener("unhandledrejection", (event) => {
        const detail = event && event.reason ? event.reason : "Unknown rejection";
        showError("Promise rejection: " + detail);
      });

      const context = cast.framework.CastReceiverContext.getInstance();
      const playerManager = context.getPlayerManager();
      const hint = document.getElementById("hint");
      let currentHeaders = {};

      // Optional: allow custom headers for manifest and segments.
      // Note: some headers like User-Agent and Referer are restricted in web environments.
      const playbackConfig = new cast.framework.PlaybackConfig();

      function parseContentId(contentId) {
        // Supported format:
        // https://example.com/stream.m3u8|Authorization=Bearer%20TOKEN&X-Token=abc
        const raw = String(contentId || "");
        const parts = raw.split("|");
        const url = parts[0].trim();
        const headers = {};

        if (parts.length > 1 && parts[1]) {
          const kv = parts[1].split("&");
          for (const pair of kv) {
            const eq = pair.indexOf("=");
            if (eq > 0) {
              const k = decodeURIComponent(pair.slice(0, eq).trim());
              const v = decodeURIComponent(pair.slice(eq + 1).trim());
              if (k && v) headers[k] = v;
            }
          }
        }
        return { url, headers };
      }

      playbackConfig.manifestRequestHandler = (requestInfo) => {
        const media = playerManager.getMediaInformation();
        const parsed = parseContentId(media && media.contentId);
        requestInfo.url = parsed.url;
        requestInfo.withCredentials = false;
        const headers = Object.keys(currentHeaders).length
          ? currentHeaders
          : parsed.headers;
        requestInfo.headers = Object.assign({}, requestInfo.headers, headers);
      };

      playbackConfig.segmentRequestHandler = (requestInfo) => {
        const media = playerManager.getMediaInformation();
        const parsed = parseContentId(media && media.contentId);
        requestInfo.withCredentials = false;
        const headers = Object.keys(currentHeaders).length
          ? currentHeaders
          : parsed.headers;
        requestInfo.headers = Object.assign({}, requestInfo.headers, headers);
      };

      playerManager.setPlaybackConfig(playbackConfig);

      // Ensure LOAD uses the URL part (before |) as the actual contentId.
      playerManager.setMessageInterceptor(
        cast.framework.messages.MessageType.LOAD,
        (loadRequestData) => {
          const parsed = parseContentId(loadRequestData.media && loadRequestData.media.contentId);
          const customData = loadRequestData && loadRequestData.customData;
          const customHeaders = customData && customData.headers ? customData.headers : null;
          currentHeaders = customHeaders && Object.keys(customHeaders).length
            ? customHeaders
            : parsed.headers;

          if (customData && customData.contentType && loadRequestData.media) {
            loadRequestData.media.contentType = customData.contentType;
          }

          loadRequestData.media.contentId = parsed.url;
          if (hint) hint.style.display = "none";
          return loadRequestData;
        }
      );

      playerManager.addEventListener(
        cast.framework.events.EventType.PLAYER_STATE_CHANGED,
        (event) => {
          if (!hint) return;
          if (event && event.state === cast.framework.messages.PlayerState.IDLE) {
            hint.style.display = "";
          } else {
            hint.style.display = "none";
          }
        }
      );

      context.addEventListener(
        cast.framework.system.EventType.ERROR,
        (event) => {
          const detail = event && event.error ? event.error : event;
          showError("Cast error: " + JSON.stringify(detail));
        }
      );

      context.start();
    </script>
  </body>
</html>
